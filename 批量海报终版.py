{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "50c2dd22-f1b0-486f-b367-6ddd0344b9a3",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“‘ è¯»å–åˆ° 13 æ¡æ•°æ®\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: ä¸Šæµ·æµ¦å‘é“¶è¡Œå¥³ç¯®VSå±±ä¸œèµ¤æ°´æ²³é…’å¥³ç¯® (2025-12-21 19:30:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: 2025â€œå† å†›æ‘‡ç¯®æ¯â€é’å°‘å¹´ç½‘çƒèµ› (2025-12-20 08:00:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: 2025â€œå† å†›æ‘‡ç¯®æ¯â€é’å°‘å¹´ç½‘çƒèµ› (2025-12-21 08:00:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: åŒæ—¦æŒ‘æˆ˜èµ›äº²å­æ´»åŠ¨ (2025-12-20 13:00:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: 2025å¹´æ¨æµ¦åŒºå­¦ç”Ÿé˜³å…‰ä½“è‚²å¤§è”èµ›ä¸­å°å­¦ç”Ÿè¶³çƒæ¯”èµ› (2025-12-20 09:00:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: 2025å¹´æ¨æµ¦åŒºå­¦ç”Ÿé˜³å…‰ä½“è‚²å¤§è”èµ›ä¸­å°å­¦ç”Ÿè¶³çƒæ¯”èµ› (2025-12-21 09:00:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: 2025å¹´æ¨æµ¦åŒºå­¦ç”Ÿé˜³å…‰ä½“è‚²å¤§è”èµ›ä¸­å°å­¦ç”Ÿè¶³çƒæ¯”èµ› (2025-12-21 09:00:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: 2025å¹´åº¦ä¸Šæµ·ç‡ƒæ°”æµ¦ä¸œé”€å”®æœ‰é™å…¬å¸èŒå·¥å¡ä¸è½¦æ¯”èµ› (2025-12-23 12:00:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: 2025-2026å­¦å¹´ä¸Šæµ·å¸‚ä¸­å°å­¦ç”Ÿç¾½æ¯›çƒé”¦æ ‡èµ› (2025-12-20 10:00:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: 2025-2026å­¦å¹´ä¸Šæµ·å¸‚ä¸­å°å­¦ç”Ÿç¾½æ¯›çƒé”¦æ ‡èµ› (2025-12-21 10:00:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: å¹¸ç¦ä¸œèˆªæ¯ ä¸Šæµ·åœ°åŒºèŒå·¥ç¾½æ¯›çƒæ¯”èµ› (2025-12-23 08:30:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: å¹¸ç¦ä¸œèˆªæ¯ ä¸Šæµ·åœ°åŒºèŒå·¥ç¾½æ¯›çƒæ¯”èµ› (2025-12-24 08:30:00)\n",
      "âœ… å·²ç”Ÿæˆæµ·æŠ¥: 2025å¹´ç¬¬ä¹å±Šâ€œè·†åæ¯â€ä¸Šæµ·å¸‚è·†æ‹³é“è”èµ›æ€»å†³èµ› (2025-12-20 07:30:00)\n",
      "\n",
      "ğŸ‰ æ‰€æœ‰æµ·æŠ¥å·²ç”Ÿæˆï¼è¯·æŸ¥çœ‹ output æ–‡ä»¶å¤¹\n"
     ]
    }
   ],
   "source": [
    "from PIL import Image, ImageDraw, ImageFont\n",
    "import pandas as pd\n",
    "import qrcode\n",
    "import requests\n",
    "import io\n",
    "import os\n",
    "import json\n",
    "\n",
    "# ==== é…ç½®åŒºåŸŸ ====\n",
    "FONT_PATH = \"/Users/feidabao/Library/Fonts/SourceHanSansCN-Medium.otf\"  # æ ‡é¢˜/æ–‡å­—å­—ä½“\n",
    "DATA_FILE = \"data.xlsx\"  # Excel æ–‡ä»¶\n",
    "KV_FOLDER = \"kv_imgs\"  # KV å›¾ç‰‡ä¸´æ—¶ä¿å­˜\n",
    "OUTPUT_FOLDER = \"output\"  # è¾“å‡ºæµ·æŠ¥\n",
    "LEFT_MARGIN = 50  # å·¦å¯¹é½è¾¹è·\n",
    "LINE_SPACING = 5  # è¡Œé—´è·\n",
    "\n",
    "# æµ·æŠ¥å®½åº¦\n",
    "POSTER_WIDTH = 750\n",
    "\n",
    "# æ¥å£å‰ç¼€\n",
    "SIGN_API_PREFIX = \"è¾“å…¥ä½ çš„æ¥å£å‰ç¼€\"\n",
    "\n",
    "# ==== å‡½æ•°ï¼šè‡ªåŠ¨æ¢è¡Œç»˜åˆ¶æ–‡å­— ====\n",
    "def draw_wrap_text(draw, text, font, x, y, max_width, fill=\"#000000\"):\n",
    "    \"\"\"ä¸­æ–‡é€å­—æ‹†åˆ†è‡ªåŠ¨æ¢è¡Œï¼Œå·¦å¯¹é½\"\"\"\n",
    "    current_line = \"\"\n",
    "    current_y = y\n",
    "    for char in text:\n",
    "        test_line = current_line + char\n",
    "        bbox = draw.textbbox((0,0), test_line, font=font)\n",
    "        w = bbox[2] - bbox[0]\n",
    "        if w > max_width:\n",
    "            draw.text((x, current_y), current_line, font=font, fill=fill)\n",
    "            current_y += font.size + LINE_SPACING\n",
    "            current_line = char\n",
    "        else:\n",
    "            current_line = test_line\n",
    "    if current_line:\n",
    "        draw.text((x, current_y), current_line, font=font, fill=fill)\n",
    "        current_y += font.size + LINE_SPACING\n",
    "    return current_y  # è¿”å›æ–‡å­—åº•éƒ¨ y åæ ‡\n",
    "\n",
    "# ==== åˆ›å»ºæ–‡ä»¶å¤¹ ====\n",
    "for folder in [KV_FOLDER, OUTPUT_FOLDER]:\n",
    "    if not os.path.exists(folder):\n",
    "        os.makedirs(folder)\n",
    "\n",
    "# ==== è¯»å–è¡¨æ ¼ ====\n",
    "df = pd.read_excel(DATA_FILE)\n",
    "print(f\"ğŸ“‘ è¯»å–åˆ° {len(df)} æ¡æ•°æ®\")\n",
    "\n",
    "# ==== ä¸»å¾ªç¯ç”Ÿæˆæµ·æŠ¥ ====\n",
    "for idx, row in df.iterrows():\n",
    "    title = str(row['title'])\n",
    "    date = str(row['date'])\n",
    "    number = str(row['number'])  # æ–°å¢â€”â€”â€”â€”ç›´æ’­é—´å·\n",
    "    link = str(row['link'])\n",
    "    kv_base_url = str(row['kv_image_name'])  # Excel ä¸­å­˜çš„ URL å‰åŠæ®µ\n",
    "\n",
    "    # è¯·æ±‚æ¥å£è·å–å®Œæ•´å¸¦ç­¾å URL\n",
    "    try:\n",
    "        resp = requests.get(SIGN_API_PREFIX + kv_base_url)\n",
    "        resp.raise_for_status()\n",
    "        data = resp.json()\n",
    "        kv_url = data.get(\"limgurl\") or data.get(\"imgurl\")  # ä¼˜å…ˆä½¿ç”¨å¤§å›¾\n",
    "    except Exception as e:\n",
    "        print(f\"âŒ å›¾ç‰‡ä¸‹è½½å¤±è´¥: {title}ï¼ŒåŸå› : {e}\")\n",
    "        continue\n",
    "\n",
    "    # ä¸‹è½½ KV å›¾ç‰‡åˆ°å†…å­˜\n",
    "    try:\n",
    "        img_resp = requests.get(kv_url)\n",
    "        img_resp.raise_for_status()\n",
    "        kv_img = Image.open(io.BytesIO(img_resp.content)).convert(\"RGB\")\n",
    "    except Exception as e:\n",
    "        print(f\"âŒ å›¾ç‰‡ä¸‹è½½å¤±è´¥: {title}ï¼ŒåŸå› : {e}\")\n",
    "        continue\n",
    "\n",
    "    # KV å›¾ç‰‡å®½åº¦è‡ªé€‚åº”æµ·æŠ¥å®½åº¦ï¼Œé«˜åº¦æŒ‰åŸæ¯”ä¾‹ä¿ç•™\n",
    "    kv_w, kv_h = kv_img.size\n",
    "    new_w = POSTER_WIDTH\n",
    "    new_h = int(kv_h * (new_w / kv_w))\n",
    "    kv_img = kv_img.resize((new_w, new_h))  # å®½åº¦æ’‘æ»¡æµ·æŠ¥å®½åº¦ï¼Œé«˜åº¦ç­‰æ¯”ä¾‹\n",
    "\n",
    "    # æ–‡å­—å­—ä½“\n",
    "    font_title = ImageFont.truetype(FONT_PATH, 40)\n",
    "    font_date = ImageFont.truetype(FONT_PATH, 24)\n",
    "    font_number = ImageFont.truetype(FONT_PATH, 20)\n",
    "    font_tips = ImageFont.truetype(FONT_PATH, 32)\n",
    "\n",
    "    # ä¸´æ—¶è®¡ç®—æ ‡é¢˜å’Œæ—¥æœŸé«˜åº¦\n",
    "    temp_img = Image.new(\"RGB\", (new_w, 1000), \"white\")\n",
    "    draw_temp = ImageDraw.Draw(temp_img)\n",
    "    text_y = new_h + 35\n",
    "    text_y = draw_wrap_text(draw=draw_temp, text=title, font=font_title, x=LEFT_MARGIN, y=text_y, max_width=POSTER_WIDTH - 2*LEFT_MARGIN)\n",
    "    text_y = draw_wrap_text(draw=draw_temp, text=date, font=font_date, x=LEFT_MARGIN, y=text_y + 5, max_width=POSTER_WIDTH - 2*LEFT_MARGIN)\n",
    "    text_y = draw_wrap_text(draw=draw_temp, text=f\"ç›´æ’­é—´å·:{number}\", font=font_number, x=LEFT_MARGIN, y=text_y + 5, max_width=POSTER_WIDTH - 2*LEFT_MARGIN)\n",
    "\n",
    "    # äºŒç»´ç å’Œå›ºå®šæ–‡æ¡ˆé«˜åº¦\n",
    "    qr_size = 400\n",
    "    tips_height = font_tips.size\n",
    "    bottom_margin = 20\n",
    "    extra_bottom_space = 50  # åº•éƒ¨é¢å¤–ç™½è‰²ç©ºé—´\n",
    "\n",
    "    poster_height = text_y + qr_size + tips_height + 3*LINE_SPACING + bottom_margin + extra_bottom_space\n",
    "\n",
    "    # æ–°å»ºæµ·æŠ¥\n",
    "    poster = Image.new(\"RGB\", (POSTER_WIDTH, poster_height), \"white\")\n",
    "    poster.paste(kv_img, (0,0))\n",
    "    draw = ImageDraw.Draw(poster)\n",
    "\n",
    "    # ç»˜åˆ¶æ ‡é¢˜ã€æ—¥æœŸã€ç›´æ’­é—´å·\n",
    "    text_y = new_h + 35\n",
    "    text_y = draw_wrap_text(draw=draw, text=title, font=font_title, x=LEFT_MARGIN, y=text_y, max_width=POSTER_WIDTH - 2*LEFT_MARGIN, fill=\"#333333\")\n",
    "    text_y = draw_wrap_text(draw=draw, text=date, font=font_date, x=LEFT_MARGIN, y=text_y + 5, max_width=POSTER_WIDTH - 2*LEFT_MARGIN, fill=\"#999999\")\n",
    "    text_y = draw_wrap_text(draw=draw, text=f\"ç›´æ’­é—´å·:{number}\", font=font_number, x=LEFT_MARGIN, y=text_y + 5, max_width=POSTER_WIDTH - 2*LEFT_MARGIN, fill=\"#999999\")\n",
    "\n",
    "    # äºŒç»´ç \n",
    "    qr = qrcode.make(link)\n",
    "    qr = qr.resize((qr_size, qr_size))\n",
    "    qr_y = text_y + 15\n",
    "    poster.paste(qr, ((POSTER_WIDTH - qr_size)//2, qr_y))\n",
    "\n",
    "    # å›ºå®šæ–‡æ¡ˆå±…ä¸­\n",
    "    tips_text = \"å¡«å…¥ä½ çš„æ–‡æ¡ˆ\"\n",
    "    bbox = draw.textbbox((0,0), tips_text, font=font_tips)\n",
    "    tw = bbox[2] - bbox[0]\n",
    "    draw.text(((POSTER_WIDTH - tw)//2, qr_y + qr_size + 15), tips_text, font=font_tips, fill=\"#999999\")\n",
    "\n",
    "    # ä¿å­˜æµ·æŠ¥\n",
    "    # ä¿å­˜æµ·æŠ¥ï¼ˆé˜²æ­¢é‡åè¦†ç›–ï¼Œä½¿ç”¨æ ‡é¢˜+æ—¥æœŸä½œä¸ºæ–‡ä»¶åï¼‰\n",
    "    safe_title = \"\".join(c if c not in \"/\\\\:*?\\\"<>|\" else \"_\" for c in title)\n",
    "\n",
    "    safe_date = \"\".join(c if c not in \"/\\\\:*?\\\"<>|\" else \"_\" for c in date)  # å¯¹æ—¥æœŸä¹Ÿåšå®‰å…¨å¤„ç†\n",
    "\n",
    "    output_filename = f\"{safe_title}_{safe_date}.jpg\"\n",
    "    output_path = os.path.join(OUTPUT_FOLDER, output_filename)\n",
    "    poster.save(output_path, \"JPEG\")\n",
    "    print(f\"âœ… å·²ç”Ÿæˆæµ·æŠ¥: {title} ({date})\")\n",
    "\n",
    "\n",
    "print(\"\\nğŸ‰ æ‰€æœ‰æµ·æŠ¥å·²ç”Ÿæˆï¼è¯·æŸ¥çœ‹ output æ–‡ä»¶å¤¹\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "3c34fb6c-a619-41b8-8b57-fd8c48a91904",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python [conda env:base] *",
   "language": "python",
   "name": "conda-base-py"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
